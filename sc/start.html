<!DOCTYPE html>
<html>
<head>
    <title>Working Private Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        #send-button { width: 25%; padding: 8px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .your-message { background-color: #e3f2fd; text-align: right; }
        .their-message { background-color: #f1f1f1; text-align: left; }
        #status { color: #666; margin-bottom: 10px; }
        #login { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Private Chat 游눫</h1>
    <div id="login">
        <h3>Enter GitHub Token</h3>
        <input type="password" id="github-token" placeholder="Paste GitHub Token">
        <button id="login-btn">Connect</button>
    </div>
    <div id="status">游댮 Disconnected</div>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="Type your message..." disabled>
    <button id="send-button" disabled>Send</button>

    <script>
        // CONFIG - CHANGE THESE!
        const REPO = "amirhjrad/amirhjrad.github.io"; // e.g. "myusername/myrepo"
        const CHAT_FILE = "chat-data.json";
        const SYNC_INTERVAL = 3000; // 3 seconds

        // DOM Elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusDiv = document.getElementById('status');
        const tokenInput = document.getElementById('github-token');
        const loginBtn = document.getElementById('login-btn');

        let githubToken = "";
        let messages = [];
        let lastUpdate = 0;
        let currentSHA = null;
        let isSaving = false;

        // 1. Login with GitHub Token
        loginBtn.addEventListener('click', async () => {
            githubToken = tokenInput.value.trim();
            if (!githubToken) return alert("Enter GitHub Token!");
            
            statusDiv.textContent = "游릭 Connecting...";
            try {
                await loadMessages();
                document.getElementById('login').style.display = "none";
                messageInput.disabled = false;
                sendButton.disabled = false;
                statusDiv.textContent = "游릭 Connected! Last sync: " + new Date().toLocaleTimeString();
                setInterval(loadMessages, SYNC_INTERVAL);
            } catch (err) {
                statusDiv.textContent = "游댮 Error: " + err.message;
                console.error(err);
            }
        });

        // 2. Load messages with error handling
        async function loadMessages() {
            try {
                const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}?t=${Date.now()}`;
                const response = await fetch(url, {
                    headers: { Authorization: `token ${githubToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error("chat-data.json missing! Create it first");
                    }
                    throw new Error("GitHub API error");
                }
                
                const data = await response.json();
                const content = JSON.parse(atob(data.content));
                currentSHA = data.sha;
                
                if (content.lastUpdate > lastUpdate) {
                    lastUpdate = content.lastUpdate;
                    messages = content.messages;
                    updateChat();
                    statusDiv.textContent = "游릭 Connected! Last sync: " + new Date().toLocaleTimeString();
                }
            } catch (err) {
                console.error("Sync error:", err);
                statusDiv.textContent = "游댮 Sync error - retrying...";
            }
        }

        // 3. Save messages with retry logic
        async function saveMessages(newMessages) {
            if (isSaving) return;
            isSaving = true;
            
            try {
                // Get latest SHA first to prevent conflicts
                const shaUrl = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                const shaResponse = await fetch(shaUrl, {
                    headers: { Authorization: `token ${githubToken}` }
                });
                
                if (!shaResponse.ok) throw new Error("Couldn't get file version");
                const shaData = await shaResponse.json();
                currentSHA = shaData.sha;
                
                // Now save with the latest SHA
                const saveUrl = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                const saveResponse = await fetch(saveUrl, {
                    method: "PUT",
                    headers: { Authorization: `token ${githubToken}` },
                    body: JSON.stringify({
                        message: "Chat update at " + new Date().toISOString(),
                        content: btoa(JSON.stringify({
                            messages: newMessages,
                            lastUpdate: Date.now()
                        })),
                        sha: currentSHA
                    })
                });
                
                if (!saveResponse.ok) {
                    const errorData = await saveResponse.json();
                    throw new Error(errorData.message || "Save failed");
                }
                
                messages = newMessages;
                updateChat();
                statusDiv.textContent = "游릭 Message sent! Last sync: " + new Date().toLocaleTimeString();
                
            } catch (err) {
                console.error("Save error:", err);
                statusDiv.textContent = "游댮 Error saving - retrying...";
                setTimeout(() => saveMessages(newMessages), 2000); // Retry after 2 seconds
                return;
            } finally {
                isSaving = false;
            }
        }

        // 4. Update chat display
        function updateChat() {
            chatBox.innerHTML = "";
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender === "you" ? "your-message" : "their-message"}`;
                div.innerHTML = `
                    <strong>${msg.sender}:</strong> ${msg.text}
                    <small>${new Date(msg.time).toLocaleTimeString()}</small>
                `;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 5. Send message with loading state
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text || isSaving) return;
            
            const newMessages = [...messages, {
                sender: "you",
                text: text,
                time: new Date().toISOString()
            }];
            
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendButton.textContent = "Sending...";
            
            await saveMessages(newMessages);
            
            messageInput.value = "";
            messageInput.disabled = false;
            sendButton.disabled = false;
            sendButton.textContent = "Send";
        });

        // Press Enter to send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === "Enter") sendButton.click();
        });
    </script>
</body>
</html>
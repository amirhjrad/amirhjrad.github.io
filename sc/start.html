<!DOCTYPE html>
<html>
<head>
    <title>Private Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        #send-button { width: 25%; padding: 8px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .your-message { background-color: #e3f2fd; text-align: right; }
        .their-message { background-color: #f1f1f1; text-align: left; }
        #status { color: #666; margin-bottom: 10px; }
        #login { margin-bottom: 15px; }
        .timestamp { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>
    <h1>Private Chat ðŸ’¬</h1>
    <div id="login">
        <h3>Enter GitHub Token</h3>
        <input type="password" id="github-token" placeholder="Paste GitHub Token">
        <button id="login-btn">Connect</button>
    </div>
    <div id="status">ðŸ”´ Disconnected</div>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="Type your message..." disabled>
    <button id="send-button" disabled>Send</button>

    <script>
        // CONFIGURATION - CHANGE THESE!
        const REPO = "amirhjrad/amirhjrad.github.io"; // e.g. "myusername/myrepo"
        const CHAT_FILE = "chat-data.json";
        const SYNC_INTERVAL = 5000; // 5 seconds
        const MAX_RETRIES = 3; // Max retry attempts

        // DOM Elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusDiv = document.getElementById('status');
        const tokenInput = document.getElementById('github-token');
        const loginBtn = document.getElementById('login-btn');

        // Chat State
        let githubToken = "";
        let messages = [];
        let lastUpdate = 0;
        let currentSHA = null;
        let isSaving = false;
        let retryCount = 0;

        // 1. Login with GitHub Token
        loginBtn.addEventListener('click', async () => {
            githubToken = tokenInput.value.trim();
            if (!githubToken) return alert("Please enter your GitHub token");
            
            statusDiv.textContent = "ðŸŸ  Connecting to GitHub...";
            try {
                await initializeChat();
                document.getElementById('login').style.display = "none";
                messageInput.disabled = false;
                sendButton.disabled = false;
                statusDiv.textContent = "ðŸŸ¢ Connected! Last sync: " + new Date().toLocaleTimeString();
                setInterval(loadMessages, SYNC_INTERVAL);
            } catch (err) {
                statusDiv.textContent = "ðŸ”´ Connection failed: " + err.message;
                console.error(err);
            }
        });

        // 2. Initialize chat (load or create file)
        async function initializeChat() {
            try {
                // First try to load existing chat
                await loadMessages();
            } catch (loadError) {
                if (loadError.message.includes("404")) {
                    // File doesn't exist - create it
                    statusDiv.textContent = "ðŸŸ  Creating chat file...";
                    await createChatFile();
                    await loadMessages();
                } else {
                    throw loadError;
                }
            }
        }

        // 3. Load messages from GitHub
        async function loadMessages() {
            try {
                const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}?t=${Date.now()}`;
                const response = await fetch(url, {
                    headers: { Authorization: `token ${githubToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(response.status === 404 ? "Chat file not found" : "GitHub API error");
                }
                
                const data = await response.json();
                const content = JSON.parse(atob(data.content));
                currentSHA = data.sha;
                
                if (content.lastUpdate > lastUpdate) {
                    lastUpdate = content.lastUpdate;
                    messages = content.messages;
                    updateChat();
                    statusDiv.textContent = "ðŸŸ¢ Connected! Last sync: " + new Date().toLocaleTimeString();
                    retryCount = 0; // Reset retry counter on success
                }
            } catch (err) {
                console.error("Sync error:", err);
                retryCount++;
                if (retryCount >= MAX_RETRIES) {
                    statusDiv.textContent = "ðŸ”´ Sync failed - please refresh";
                } else {
                    statusDiv.textContent = "ðŸŸ  Syncing... (attempt " + retryCount + ")";
                }
            }
        }

        // 4. Create new chat file
        async function createChatFile() {
            const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const response = await fetch(url, {
                method: "PUT",
                headers: { Authorization: `token ${githubToken}` },
                body: JSON.stringify({
                    message: "Initial chat file creation",
                    content: btoa(JSON.stringify({
                        messages: [],
                        lastUpdate: 0
                    }))
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Failed to create chat file");
            }
        }

        // 5. Save messages to GitHub
        async function saveMessages(newMessages) {
            if (isSaving) return;
            isSaving = true;
            let retries = 0;
            
            while (retries < MAX_RETRIES) {
                try {
                    // First get latest SHA to prevent conflicts
                    const shaUrl = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                    const shaResponse = await fetch(shaUrl, {
                        headers: { Authorization: `token ${githubToken}` }
                    });
                    
                    if (!shaResponse.ok) throw new Error("Couldn't get file version");
                    const shaData = await shaResponse.json();
                    currentSHA = shaData.sha;
                    
                    // Now save with the latest SHA
                    const saveUrl = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                    const saveResponse = await fetch(saveUrl, {
                        method: "PUT",
                        headers: { Authorization: `token ${githubToken}` },
                        body: JSON.stringify({
                            message: "Chat update at " + new Date().toISOString(),
                            content: btoa(JSON.stringify({
                                messages: newMessages,
                                lastUpdate: Date.now()
                            })),
                            sha: currentSHA
                        })
                    });
                    
                    if (!saveResponse.ok) {
                        const errorData = await saveResponse.json();
                        throw new Error(errorData.message || "Save failed");
                    }
                    
                    // Success!
                    messages = newMessages;
                    updateChat();
                    statusDiv.textContent = "ðŸŸ¢ Message sent! Last sync: " + new Date().toLocaleTimeString();
                    isSaving = false;
                    return;
                    
                } catch (err) {
                    console.error("Save error (attempt " + (retries + 1) + "):", err);
                    retries++;
                    if (retries < MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                    }
                }
            }
            
            // If we get here, all retries failed
            statusDiv.textContent = "ðŸ”´ Failed to save after " + MAX_RETRIES + " attempts";
            isSaving = false;
            throw new Error("Max retries exceeded");
        }

        // 6. Update chat display
        function updateChat() {
            chatBox.innerHTML = "";
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender === "you" ? "your-message" : "their-message"}`;
                div.innerHTML = `
                    <strong>${msg.sender}:</strong> ${msg.text}
                    <div class="timestamp">${new Date(msg.time).toLocaleTimeString()}</div>
                `;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 7. Send message
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text || isSaving) return;
            
            const newMessages = [...messages, {
                sender: "you",
                text: text,
                time: new Date().toISOString()
            }];
            
            // Optimistically update UI
            messages = newMessages;
            updateChat();
            messageInput.value = "";
            
            // Disable input while saving
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendButton.textContent = "Sending...";
            
            try {
                await saveMessages(newMessages);
            } catch (err) {
                // Revert if save failed
                messages = messages.slice(0, -1);
                updateChat();
                messageInput.value = text;
                alert("Failed to send message. Please try again.");
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.textContent = "Send";
                messageInput.focus();
            }
        });

        // Press Enter to send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === "Enter") sendButton.click();
        });
    </script>
</body>
</html>
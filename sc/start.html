<!DOCTYPE html>
<html>
<head>
    <title>Iran-Friendly Private Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        #send-button { width: 25%; padding: 8px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .your-message { background-color: #e3f2fd; text-align: right; }
        .their-message { background-color: #f1f1f1; text-align: left; }
        #status { color: #666; margin-bottom: 10px; }
        #login { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Private Chat ðŸ’¬</h1>
    <div id="login">
        <h3>Enter GitHub Token</h3>
        <input type="password" id="github-token" placeholder="Paste GitHub Token">
        <button id="login-btn">Connect</button>
    </div>
    <div id="status">ðŸ”´ Disconnected</div>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="Type your message..." disabled>
    <button id="send-button" disabled>Send</button>

    <script>
        // Config
        const REPO = "amirhjrad/amirhjrad.github.io"; // e.g., "myusername/myrepo"
        const CHAT_FILE = "chat-data.json";
        const POLL_TIMEOUT = 30000; // 30 seconds (GitHub API timeout)

        // DOM
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusDiv = document.getElementById('status');
        const tokenInput = document.getElementById('github-token');
        const loginBtn = document.getElementById('login-btn');

        let githubToken = "";
        let messages = [];
        let lastUpdate = 0;
        let isPolling = false;

        // Login with GitHub Token
        loginBtn.addEventListener('click', () => {
            githubToken = tokenInput.value.trim();
            if (!githubToken) return alert("Enter GitHub Token!");
            
            statusDiv.textContent = "ðŸŸ¢ Connected to GitHub";
            document.getElementById('login').style.display = "none";
            messageInput.disabled = false;
            sendButton.disabled = false;
            
            startLongPolling();
        });

        // Long-polling for new messages
        function startLongPolling() {
            if (isPolling) return;
            isPolling = true;
            
            const poll = async () => {
                try {
                    const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}?t=${Date.now()}`;
                    const response = await fetch(url, {
                        headers: { Authorization: `token ${githubToken}` }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            await createChatFile();
                        }
                        throw new Error("Failed to fetch messages");
                    }
                    
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    
                    if (content.lastUpdate > lastUpdate) {
                        lastUpdate = content.lastUpdate;
                        messages = content.messages;
                        updateChat();
                    }
                    
                    // Immediately poll again if no error
                    setTimeout(poll, 100);
                    
                } catch (err) {
                    statusDiv.textContent = "ðŸ”´ Error: " + err.message;
                    console.error(err);
                    
                    // Retry after 5 seconds on error
                    setTimeout(poll, 5000);
                }
            };
            
            poll();
        }

        // Create chat file if it doesn't exist
        async function createChatFile() {
            const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const response = await fetch(url, {
                method: "PUT",
                headers: { Authorization: `token ${githubToken}` },
                body: JSON.stringify({
                    message: "Create chat file",
                    content: btoa(JSON.stringify({
                        messages: [],
                        lastUpdate: 0
                    }))
                })
            });
            
            if (!response.ok) throw new Error("Failed to create chat file");
        }

        // Save messages to GitHub
        async function saveMessages(newMessages) {
            try {
                messages = newMessages;
                lastUpdate = Date.now();
                
                const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                const response = await fetch(url, {
                    method: "PUT",
                    headers: { Authorization: `token ${githubToken}` },
                    body: JSON.stringify({
                        message: "Update chat",
                        content: btoa(JSON.stringify({
                            messages,
                            lastUpdate
                        })),
                        sha: await getFileSHA()
                    })
                });
                
                if (!response.ok) throw new Error("Failed to save");
                updateChat();
            } catch (err) {
                statusDiv.textContent = "ðŸ”´ Error saving: " + err.message;
                console.error(err);
            }
        }

        // Get file SHA (needed for updates)
        async function getFileSHA() {
            const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const response = await fetch(url, {
                headers: { Authorization: `token ${githubToken}` }
            });
            
            if (!response.ok) return null;
            const data = await response.json();
            return data.sha;
        }

        // Update chat UI
        function updateChat() {
            chatBox.innerHTML = "";
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender === "you" ? "your-message" : "their-message"}`;
                div.textContent = msg.text;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Send message
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text) return;
            
            messages.push({
                sender: "you",
                text,
                time: new Date().toISOString()
            });
            
            await saveMessages(messages);
            messageInput.value = "";
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === "Enter") sendButton.click();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Iran-Friendly Private Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        #send-button { width: 25%; padding: 8px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .your-message { background-color: #e3f2fd; text-align: right; }
        .their-message { background-color: #f1f1f1; text-align: left; }
        #status { color: #666; margin-bottom: 10px; }
        #login { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Private Chat ðŸ’¬</h1>
    <div id="login">
        <h3>Enter GitHub Token</h3>
        <input type="password" id="github-token" placeholder="Paste GitHub Token">
        <button id="login-btn">Connect</button>
    </div>
    <div id="status">ðŸ”´ Disconnected</div>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="Type your message..." disabled>
    <button id="send-button" disabled>Send</button>

    <script>
        // CONFIG - CHANGE THIS!
        const REPO = "amirhjrad/amirhjrad.github.io"; // e.g. "myusername/myrepo"
        const CHAT_FILE = "chat-data.json";

        // DOM Elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusDiv = document.getElementById('status');
        const tokenInput = document.getElementById('github-token');
        const loginBtn = document.getElementById('login-btn');

        let githubToken = "";
        let messages = [];
        let lastUpdate = 0;
        let currentSHA = null;

        // 1. Login with GitHub Token
        loginBtn.addEventListener('click', async () => {
            githubToken = tokenInput.value.trim();
            if (!githubToken) return alert("Enter GitHub Token!");
            
            statusDiv.textContent = "ðŸŸ¢ Connecting...";
            try {
                // First, try to load the existing chat file
                await loadMessages();
                
                // If successful, start the chat
                document.getElementById('login').style.display = "none";
                messageInput.disabled = false;
                sendButton.disabled = false;
                statusDiv.textContent = "ðŸŸ¢ Connected!";
                
                // Start checking for new messages
                setInterval(loadMessages, 3000); // Check every 3 seconds
                
            } catch (err) {
                statusDiv.textContent = "ðŸ”´ Error: " + err.message;
                console.error(err);
            }
        });

        // 2. Load messages from GitHub
        async function loadMessages() {
            try {
                const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                const response = await fetch(url, {
                    headers: { Authorization: `token ${githubToken}` }
                });
                
                if (!response.ok) {
                    throw new Error("Could not load chat. Make sure chat-data.json exists!");
                }
                
                const data = await response.json();
                const content = JSON.parse(atob(data.content));
                
                // Update SHA for future saves
                currentSHA = data.sha;
                
                // Only update if there are new messages
                if (content.lastUpdate > lastUpdate) {
                    lastUpdate = content.lastUpdate;
                    messages = content.messages;
                    updateChat();
                }
                
            } catch (err) {
                console.error("Error loading messages:", err);
                throw err;
            }
        }

        // 3. Save messages to GitHub
        async function saveMessages(newMessages) {
            try {
                const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
                const response = await fetch(url, {
                    method: "PUT",
                    headers: { Authorization: `token ${githubToken}` },
                    body: JSON.stringify({
                        message: "Chat update",
                        content: btoa(JSON.stringify({
                            messages: newMessages,
                            lastUpdate: Date.now()
                        })),
                        sha: currentSHA // This is critical for updates
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Failed to save");
                }
                
                // Update local copy
                messages = newMessages;
                updateChat();
                
            } catch (err) {
                console.error("Error saving:", err);
                statusDiv.textContent = "ðŸ”´ Error saving - try again";
                throw err;
            }
        }

        // 4. Update the chat display
        function updateChat() {
            chatBox.innerHTML = "";
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender === "you" ? "your-message" : "their-message"}`;
                div.textContent = `${msg.sender}: ${msg.text}`;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 5. Send message
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text) return;
            
            try {
                const newMessages = [...messages, {
                    sender: "you",
                    text: text,
                    time: new Date().toISOString()
                }];
                
                await saveMessages(newMessages);
                messageInput.value = "";
                
            } catch (err) {
                alert("Failed to send message. Please try again.");
            }
        });

        // Press Enter to send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === "Enter") sendButton.click();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Reliable Private Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 400px; border: 1px solid #ddd; padding: 10px; overflow-y: scroll; margin-bottom: 10px; background: #fafafa; }
        #message-input { width: 75%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #send-button { width: 23%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; }
        .message { margin: 10px 0; padding: 8px 12px; border-radius: 4px; }
        .your-message { background: #e3f2fd; margin-left: 20%; }
        .their-message { background: #f1f1f1; margin-right: 20%; }
        #status { padding: 8px; border-radius: 4px; margin-bottom: 10px; }
        .online { background: #e8f5e9; color: #2e7d32; }
        .offline { background: #ffebee; color: #c62828; }
        #retry-panel { display: none; background: #fff3e0; padding: 10px; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Private Chat ðŸ’¬</h1>
    <div id="status" class="offline">ðŸ”´ Disconnected</div>
    <div id="chat-box"></div>
    <div style="display: flex; gap: 10px;">
        <input type="text" id="message-input" placeholder="Type your message..." disabled>
        <button id="send-button" disabled>Send</button>
    </div>
    <div id="retry-panel">
        <p>Some messages failed to send.</p>
        <button id="retry-button">Retry Now</button>
    </div>

    <script>
        // CONFIG (Change these!)
        const REPO = "amirhjrad/amirhjrad.github.io";
        const CHAT_FILE = "chat-data.json";
        const SYNC_INTERVAL = 3000;

        // Elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusDiv = document.getElementById('status');
        const retryPanel = document.getElementById('retry-panel');
        const retryButton = document.getElementById('retry-button');

        // State
        let githubToken = "";
        let messages = [];
        let unsentMessages = [];
        let currentSHA = null;
        let isOnline = false;

        // Initialize
        startChat();

        async function startChat() {
            githubToken = localStorage.getItem('githubToken') || prompt("Enter GitHub token:");
            if (!githubToken) return alert("Token required!");
            localStorage.setItem('githubToken', githubToken);

            await initializeChat();
            setupEventListeners();
            setInterval(syncChat, SYNC_INTERVAL);
        }

        async function initializeChat() {
            statusDiv.textContent = "ðŸŸ  Connecting...";
            
            try {
                await loadChatFile();
                isOnline = true;
                statusDiv.textContent = "ðŸŸ¢ Connected";
                statusDiv.className = "online";
                retryPanel.style.display = "none";
                processUnsentMessages();
            } catch (err) {
                handleConnectionError(err);
            }
        }

        async function loadChatFile() {
            const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const res = await fetchWithRetry(url);
            
            if (res.status === 404) {
                await createChatFile();
                return;
            }
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            currentSHA = data.sha;
            messages = JSON.parse(atob(data.content)).messages;
            renderMessages();
        }

        async function createChatFile() {
            const url = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const res = await fetchWithRetry(url, {
                method: "PUT",
                body: JSON.stringify({
                    message: "Initial chat file",
                    content: btoa(JSON.stringify({ messages: [] }))
                })
            });
            
            if (!res.ok) throw new Error("Failed to create file");
        }

        async function saveMessage(text) {
            const newMessage = {
                sender: "you",
                text: text,
                time: new Date().toISOString()
            };
            
            // Optimistic UI update
            messages.push(newMessage);
            renderMessages();
            
            try {
                await performSave([...messages]);
                messageInput.value = "";
            } catch (err) {
                // Revert and queue for retry
                messages.pop();
                unsentMessages.push(newMessage);
                showRetryPanel();
                throw err;
            }
        }

        async function performSave(newMessages) {
            // Get latest file version first
            const shaUrl = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const shaRes = await fetchWithRetry(shaUrl);
            
            if (!shaRes.ok) throw new Error("Can't get file version");
            const shaData = await shaRes.json();
            
            // Save with latest SHA
            const saveUrl = `https://api.github.com/repos/${REPO}/contents/${CHAT_FILE}`;
            const saveRes = await fetchWithRetry(saveUrl, {
                method: "PUT",
                body: JSON.stringify({
                    message: `Chat update ${new Date().toISOString()}`,
                    content: btoa(JSON.stringify({ messages: newMessages })),
                    sha: shaData.sha
                })
            });
            
            if (!saveRes.ok) throw new Error("Save failed");
            currentSHA = (await saveRes.json()).sha;
        }

        async function fetchWithRetry(url, options = {}, retries = 3) {
            options.headers = {
                Authorization: `token ${githubToken}`,
                ...options.headers
            };
            
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.status === 403) await waitForRateLimit();
                    return res;
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
        }

        async function waitForRateLimit() {
            statusDiv.textContent = "ðŸŸ  Rate limited - waiting 1 minute";
            await new Promise(r => setTimeout(r, 60000));
        }

        function setupEventListeners() {
            sendButton.addEventListener('click', async () => {
                const text = messageInput.value.trim();
                if (!text) return;
                
                sendButton.disabled = true;
                messageInput.disabled = true;
                
                try {
                    await saveMessage(text);
                } catch (err) {
                    console.error("Send error:", err);
                } finally {
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            });
            
            retryButton.addEventListener('click', processUnsentMessages);
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === "Enter") sendButton.click();
            });
        }

        async function processUnsentMessages() {
            if (!unsentMessages.length || !isOnline) return;
            
            retryPanel.style.display = "none";
            const toSend = [...unsentMessages];
            unsentMessages = [];
            
            for (const msg of toSend) {
                try {
                    messages.push(msg);
                    await performSave(messages);
                } catch (err) {
                    messages.pop();
                    unsentMessages.push(msg);
                    showRetryPanel();
                    break;
                }
            }
            
            renderMessages();
        }

        function showRetryPanel() {
            if (unsentMessages.length > 0) {
                retryPanel.style.display = "block";
            }
        }

        function renderMessages() {
            chatBox.innerHTML = messages.map(msg => `
                <div class="message ${msg.sender === "you" ? "your-message" : "their-message"}">
                    <strong>${msg.sender}:</strong> ${msg.text}
                    <div style="font-size:0.8em;color:#666">
                        ${new Date(msg.time).toLocaleTimeString()}
                    </div>
                </div>
            `).join("");
            
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function syncChat() {
            try {
                await loadChatFile();
                if (!isOnline) {
                    isOnline = true;
                    statusDiv.textContent = "ðŸŸ¢ Connected";
                    statusDiv.className = "online";
                    processUnsentMessages();
                }
            } catch (err) {
                if (isOnline) {
                    isOnline = false;
                    statusDiv.textContent = "ðŸ”´ Offline - retrying...";
                    statusDiv.className = "offline";
                }
            }
        }

        function handleConnectionError(err) {
            console.error("Connection error:", err);
            statusDiv.textContent = `ðŸ”´ Error: ${err.message}`;
            statusDiv.className = "offline";
            isOnline = false;
            
            // Auto-retry after delay
            setTimeout(initializeChat, 5000);
        }
    </script>
</body>
</html>